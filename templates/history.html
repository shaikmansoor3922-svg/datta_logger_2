<!DOCTYPE html>
<html>
<head>
    <title>Full Data History</title>
    <style>
        body { font-family: Arial; padding:20px; }
        table { width:100%; border-collapse: collapse; margin-top:20px; }
        th, td { border:1px solid #ddd; padding:8px; text-align:center; }
        th { background:#f2f2f2; }
        button { padding:10px; margin:10px 5px 10px 0; cursor:pointer; }
        input { padding:5px; margin-right:10px; }
    </style>
</head>
<body>

<h2>Filter Data By Time</h2>

<label>Start Time:</label>
<input type="datetime-local" id="startTime">

<label>End Time:</label>
<input type="datetime-local" id="endTime">

<br>

<button onclick="applyFilter()">Apply Filter</button>
<button onclick="downloadData()">Download Selected Data</button>
<button onclick="window.location.href='/'">Back to Dashboard</button>

<hr>

<table>
    <thead>
        <tr>
            <th>Timestamp</th>
            <th>Sensor 1</th><th>Sensor 2</th><th>Sensor 3</th><th>Sensor 4</th>
            <th>Sensor 5</th><th>Sensor 6</th><th>Sensor 7</th><th>Sensor 8</th>
            <th>Sensor 9</th><th>Sensor 10</th><th>Sensor 11</th><th>Sensor 12</th>
            <th>Sensor 13</th><th>Sensor 14</th><th>Sensor 15</th><th>Sensor 16</th>
        </tr>
    </thead>
    <tbody id="historyBody"></tbody>
</table>

<script>

let autoRefresh;

// Convert datetime-local to server format
function formatDateTime(value) {
    if (!value) return null;
    return value.replace("T", " ") + ":00";
}

// Load history from server
async function loadHistory(start=null, end=null) {

    let url = "/history";

    if (start || end) {
        url += "?";
        if (start) url += "start=" + start;
        if (start && end) url += "&";
        if (end) url += "end=" + end;
    }

    const response = await fetch(url);
    const data = await response.json();

    const body = document.getElementById("historyBody");
    body.innerHTML = "";

    data.history.forEach(record => {

        let row = "<tr>";
        row += "<td>" + record.timestamp + "</td>";

        record.values.forEach(value => {
            row += "<td>" + value.toFixed(2) + "</td>";
        });

        row += "</tr>";

        body.innerHTML += row;
    });
}

// Apply filter button
function applyFilter() {

    const start = formatDateTime(document.getElementById("startTime").value);
    const end = formatDateTime(document.getElementById("endTime").value);

    clearInterval(autoRefresh);  // Stop auto refresh when filtering
    loadHistory(start, end);
}

// Download selected data
function downloadData() {

    const start = formatDateTime(document.getElementById("startTime").value);
    const end = formatDateTime(document.getElementById("endTime").value);

    let url = "/download";

    if (start || end) {
        url += "?";
        if (start) url += "start=" + start;
        if (start && end) url += "&";
        if (end) url += "end=" + end;
    }

    window.location.href = url;
}

// Auto refresh every 2 sec (only when no filter applied)
autoRefresh = setInterval(() => {
    loadHistory();
}, 2000);

loadHistory();

</script>

</body>
</html>
